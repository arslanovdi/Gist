APP_NAME=gist-core
IMAGE_NAME=$(APP_NAME):latest
TAR_FILE=$(APP_NAME)-latest.tar.gz
SSH_HOST=vps
REMOTE_DIR=~/gist

deploy: ssh-check builddocker saveimage copy-image loadimage copy-compose
	@set -e; \
	echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è..."; \
	ssh $(SSH_HOST) "\
		   cd $(REMOTE_DIR) && \
		   docker-compose down && \
		   docker-compose up -d && \
		   docker image prune -f"
	@echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
	docker image prune -f

ssh-check:
	@echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
	@ssh -q $(SSH_HOST) "exit 0" && echo "‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" || \
		(echo "‚ùå –û—à–∏–±–∫–∞ SSH"; exit 1)

builddocker:
	@echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
	docker build -t $(IMAGE_NAME) -f Dockerfile .

saveimage:
	@echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –≤ –∞—Ä—Ö–∏–≤..."
	docker save $(IMAGE_NAME) | gzip > $(TAR_FILE)

copy-image:
	@echo "üì° –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
	@scp $(TAR_FILE) $(SSH_HOST):/tmp/ && \
    		rm -f $(TAR_FILE) && \
    		echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä" || \
    		(echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"; exit 1)

loadimage:
	@echo "‚¨ÜÔ∏è  –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ –≤ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
	ssh $(SSH_HOST) "docker load -i /tmp/$(TAR_FILE) && rm -f /tmp/$(TAR_FILE)"
	@echo "‚úÖ –û–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω"

copy-compose:
	@ssh $(SSH_HOST) "mkdir -p $(REMOTE_DIR)"
	@scp ../compose.yaml $(SSH_HOST):$(REMOTE_DIR)/
	@echo "‚úÖ compose.yaml —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"






stop:
	echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."; \
    	ssh $(SSH_HOST) "\
    	cd $(REMOTE_DIR) && \
    	docker-compose down"

start:
	echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞..."; \
          ssh $(SSH_HOST) "\
          cd $(REMOTE_DIR) && \
          docker-compose up -d"

clean:
	echo "üóë –û—á–∏—Å—Ç–∫–∞..."; \
          ssh $(SSH_HOST) "\
          docker image prune -af && \
          docker container prune -f && \
          docker volume prune -f && \
          docker network prune -f \
          "